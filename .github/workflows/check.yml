name: Build Check
on:
  - push
jobs:
  Ubuntu_22_04:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Install packages
      run: sudo apt-get update && sudo apt-get install -y meson ninja-build cmake gettext desktop-file-utils appstream-util valac libgee-0.8-dev libgtk-4-dev libadwaita-1-dev liblua5.4-dev libgeoip-dev
    - name: Setup meson project
      run: meson setup builddir
    - name: Compile
      run:  cd builddir && ninja
    - name: Test
      run: cd builddir && ninja test

  Windows_2022:
    runs-on: windows-2022
    strategy:
      matrix:
        include:
          - { sys: mingw32, env: i686 }
          - { sys: mingw64, env: x86_64 }
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{matrix.sys}}
          update: true
          pacboy: >-
            gcc:p
            gcc-libs:p
            meson:p
            ninja:p
            pkg-config:p
            gettext:p
            appstream:p
            vala:p
            libgee:p
            libadwaita:p
            libadwaita:p
            lua:p
            geoip:p
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup meson project
        run: meson setup builddir
      - name: Compile
        run: cd builddir && ninja
      - name: Test
        run: cd builddir && ninja test
      - name: Dist
        run: |
          mkdir -p dist/bin
          cp builddir/src/gswatcher.exe dist/bin
          cp /${{matrix.sys}}/bin/{gdbus,glib-compile-schemas}.exe dist/bin
          cp /${{matrix.sys}}/bin/libgcc_s_dw2-1.dll dist/bin > /dev/null || :
          cp /${{matrix.sys}}/bin/libgcc_s_seh-1.dll dist/bin > /dev/null || :
          cp /${{matrix.sys}}/bin/lib{adwaita-1-0,cairo-2,cairo-gobject-2,cairo-script-interpreter-2,curl-4,ffi-8,graphene-1.0-0,gdk_pixbuf-2.0-0,harfbuzz-0,pango-1.0-0,GeoIP-1,glib-2.0-0,gmodule-2.0-0,gee-0.8-2,gio-2.0-0,gobject-2.0-0,gtk-4-1,intl-8,appstream-5,fribidi-0,iconv-2,pcre2-8-0,xml2-2,xmlb-2,yaml-0-2}.dll dist/bin
          cp /${{matrix.sys}}/bin/{zlib1,lua54}.dll dist/bin
      - name: Archive artifacts
        uses: actions/upload-artifact@v3
        with:
          name: win-dist-${{matrix.sys}}
          path: dist
